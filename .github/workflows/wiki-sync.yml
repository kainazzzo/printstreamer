name: Sync Docs to Wiki

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/wiki-sync.yml'

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Publish docs to wiki (inline)
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GH_NAME: github-actions[bot]
        GH_MAIL: github-actions[bot]@users.noreply.github.com
        REPO: ${{ github.repository }}
      run: |
        set -euo pipefail

        if [ ! -d "docs" ]; then
          echo "docs/ directory not found â€” nothing to publish."
          exit 0
        fi

        git --version
        WORKDIR=$(pwd)
        : > "$MAPFILE"
        find . -type f -name '*.md' -print0 | while IFS= read -r -d '' f; do
          rel="${f#./}"
          val="${rel%.md}"
          # add specific mapping entries: full path, without docs/, without archive/, basename
          printf '%s\t%s\n' "$val" "$val" >> "$MAPFILE"
          no_docs="${val#docs/}"
          if [ "$no_docs" != "$val" ]; then printf '%s\t%s\n' "$no_docs" "$val" >> "$MAPFILE"; fi
          no_arch="${val#archive/}"
          if [ "$no_arch" != "$val" ]; then printf '%s\t%s\n' "$no_arch" "$val" >> "$MAPFILE"; fi
          base="${val##*/}"
          if [ "$base" != "$val" ]; then printf '%s\t%s\n' "$base" "$val" >> "$MAPFILE"; fi
        done

        # Now rewrite links in the temp docs using the mapping (preserve anchors)
        find "$TMPDOCS" -type f -name '*.md' -print0 | while IFS= read -r -d '' file; do
          perl -0777 -pe '
            BEGIN{ open(M,"<'"$MAPFILE"'") or die $!; while(<M>){ chomp; ($k,$v)=split(/\t/, $_, 2); $m{$k} = $v unless exists $m{$k}; } }
            s{\((?!https?://)([^)#]+?)(?:\.md)?(#?[^)]*)\)}{
              my $t=$1; $t=~s{^\./}{};
              my @c = ($t, $t=~s{^docs/}{}r, $t=~s{^archive/}{}r, $t=~s{.*/}{}r);
              my $rep;
              for my $cand (@c) { if (exists $m{$cand}) { $rep = $m{$cand}; last } }
              defined $rep ? "(".$rep.$2.")" : "(".$1.$2.")";
            }gsex;
          ' -i "$file"
        done

        echo "Syncing rewritten docs -> wiki"
        # cd into the wiki clone and rsync from the rewritten docs copy into it.
        cd "$TMPDIR"
        rsync -a --delete --exclude='.git' "$TMPDOCS/" .

        # Ensure we have a branch to push to (wiki repos commonly use master)
        if ! git rev-parse --verify --quiet master >/dev/null; then
          git checkout -b master || true
        else
          git checkout master || true
        fi

        git add --all
        if git diff --staged --quiet; then
          echo "No changes to publish to wiki."
          exit 0
        fi

        git commit -m "Sync docs from repo [skip ci]"
        echo "Pushing to wiki"
        # Try master then main
        if git push origin master; then
          echo "Pushed to master"
        else
          git push origin main || (echo "Push failed; please check PAT permissions and remote branch" && exit 1)
        fi