name: Sync Docs to Wiki

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/wiki-sync.yml'

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Publish docs to wiki (inline)
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GH_NAME: github-actions[bot]
        GH_MAIL: github-actions[bot]@users.noreply.github.com
        REPO: ${{ github.repository }}
      run: |
        set -euo pipefail

        if [ ! -d "docs" ]; then
          echo "docs/ directory not found â€” nothing to publish."
          exit 0
        fi

        git --version
        git config --global user.email "$GH_MAIL"
        git config --global user.name "$GH_NAME"
        WORKDIR=$(pwd)

        # Temporary workspace for rewriting
        TMPDIR=$(mktemp -d)
        TMPDOCS="$TMPDIR/docs_copy"
        mkdir -p "$TMPDOCS"
        MAPFILE="$TMPDIR/wiki_map.tsv"
        : > "$MAPFILE"

        # Build mapping of repo docs paths -> wiki targets
        find . -type f -name '*.md' -print0 | while IFS= read -r -d '' f; do
          rel="${f#./}"
          val="${rel%.md}"
          printf '%s\t%s\n' "$val" "$val" >> "$MAPFILE"
          no_docs="${val#docs/}"
          if [ "$no_docs" != "$val" ]; then printf '%s\t%s\n' "$no_docs" "$val" >> "$MAPFILE"; fi
          no_arch="${val#archive/}"
          if [ "$no_arch" != "$val" ]; then printf '%s\t%s\n' "$no_arch" "$val" >> "$MAPFILE"; fi
          base="${val##*/}"
          if [ "$base" != "$val" ]; then printf '%s\t%s\n' "$base" "$val" >> "$MAPFILE"; fi
        done

        # Copy docs to temp and rewrite links that point to docs/ or GitHub blob URLs
        rsync -a "$WORKDIR/docs/" "$TMPDOCS/"
        find "$TMPDOCS" -type f -name '*.md' -print0 | \
          xargs -0 perl -0777 -pi -e 's#\((?:https?://[^)]+/blob/[^/]+/)?/?docs/([^\)#]+)(#?[^)]*)\)#(\1\2)#g;'

        echo "Syncing rewritten docs -> wiki"
        cd "$TMPDIR"
        rsync -a --delete --exclude='.git' "$TMPDOCS/" .

        if ! git rev-parse --verify --quiet master >/dev/null; then
          git checkout -b master || true
        else
          git checkout master || true
        fi

        git add --all
        if git diff --staged --quiet; then
          echo "No changes to publish to wiki."
          exit 0
        fi

        git commit -m "Sync docs from repo [skip ci]"
        echo "Pushing to wiki"
        if git push origin master; then
          echo "Pushed to master"
        else
          git push origin main || (echo "Push failed; please check PAT permissions and remote branch" && exit 1)
        fi