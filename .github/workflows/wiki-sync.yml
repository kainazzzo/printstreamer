name: Sync Docs to Wiki

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/wiki-sync.yml'

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Publish docs to wiki (inline)
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GH_NAME: github-actions[bot]
        GH_MAIL: github-actions[bot]@users.noreply.github.com
        REPO: ${{ github.repository }}
      run: |
        set -euo pipefail

        if [ ! -d "docs" ]; then
          echo "docs/ directory not found — nothing to publish."
          exit 0
        fi

        git --version
        git config --global user.email "$GH_MAIL"
        git config --global user.name "$GH_NAME"

        WIKI_URL="https://x-access-token:${GH_PAT}@github.com/${REPO}.wiki.git"
        WORKDIR=$(pwd)
        TMPDIR=$(mktemp -d)
        echo "Cloning wiki into $TMPDIR"
        if ! git clone "$WIKI_URL" "$TMPDIR"; then
          echo "Could not clone wiki repo — initializing empty repo at $TMPDIR"
          mkdir -p "$TMPDIR"
          git -C "$TMPDIR" init
        fi

        echo "Preparing docs copy and rewriting repo-specific links for wiki"
        # Create a temporary copy of docs to rewrite links without modifying the repo
        TMPDOCS=$(mktemp -d)
        rsync -a "$WORKDIR/docs/" "$TMPDOCS/"

        # Rewrite links that point to the repo's docs/ paths into wiki-relative links.
        # Examples handled:
        #  - (docs/Path/File.md) -> (Path/File)
        #  - (/docs/Path/File.md) -> (Path/File)
        #  - (https://github.com/OWNER/REPO/blob/main/docs/Path/File.md) -> (Path/File)
        find "$TMPDOCS" -type f -name '*.md' -print0 | xargs -0 sed -E -i \
          -e "s!\((/?docs/([^)]+)\.md)\)!(\2)!g" \
          -e "s!\((https://github\.com/[^/]+/[^/]+/blob/[^/]+/docs/([^)]+)\.md)\)!(\2)!g"

        echo "Syncing rewritten docs -> wiki"
        # cd into the wiki clone and rsync from the rewritten docs copy into it.
        cd "$TMPDIR"
        rsync -a --delete --exclude='.git' "$TMPDOCS/" .

        # Ensure we have a branch to push to (wiki repos commonly use master)
        if ! git rev-parse --verify --quiet master >/dev/null; then
          git checkout -b master || true
        else
          git checkout master || true
        fi

        git add --all
        if git diff --staged --quiet; then
          echo "No changes to publish to wiki."
          exit 0
        fi

        git commit -m "Sync docs from repo [skip ci]"
        echo "Pushing to wiki"
        # Try master then main
        if git push origin master; then
          echo "Pushed to master"
        else
          git push origin main || (echo "Push failed; please check PAT permissions and remote branch" && exit 1)
        fi