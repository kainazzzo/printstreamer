name: Sync Docs to Wiki

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/wiki-sync.yml'

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Publish docs to wiki (inline)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_NAME: github-actions[bot]
          GH_MAIL: github-actions[bot]@users.noreply.github.com
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ ! -d "docs" ]; then
            echo "docs/ directory not found â€” nothing to publish."
            exit 0
          fi

          git --version
          git config --global user.email "$GH_MAIL"
          git config --global user.name "$GH_NAME"
          WORKDIR=$(pwd)

          TMPDIR=$(mktemp -d)
          TMPDOCS="$TMPDIR/docs_copy"
          mkdir -p "$TMPDOCS"

          echo "Cloning wiki into $TMPDIR"
          declare -a CANDIDATES
          if [ -n "${GH_PAT-}" ]; then
            CANDIDATES+=("https://x-access-token:${GH_PAT}@github.com/${REPO}.wiki.git")
          else
            CANDIDATES+=("git@github.com:${REPO}.wiki.git" "https://github.com/${REPO}.wiki.git")
          fi
          CLONED=0
          for url in "${CANDIDATES[@]}"; do
            echo "Trying: $url"
            if git clone --depth 1 "$url" "$TMPDIR" >/dev/null 2>&1; then
              echo "Cloned wiki from $url"
              CLONED=1
              break
            else
              echo "Failed to clone from $url"
            fi
          done
          if [ "$CLONED" -ne 1 ]; then
            echo "Warning: could not clone wiki (wiki may not be enabled or authentication failed)." >&2
            echo "Proceeding with empty wiki clone at $TMPDIR so we can still compare file lists." >&2
            mkdir -p "$TMPDIR"
          fi

          # Copy docs into a temp folder and rewrite simple docs/ prefixes in links
          rsync -a "$WORKDIR/docs/" "$TMPDOCS/"

          # Rewrite patterns like (docs/path/file.md) or (/docs/path/file.md) or blob URLs ending with /docs/...
          # Use a small Python script to do atomic in-place edits to avoid sed quoting/portability issues
          TMPDOCS="$TMPDOCS" python3 - <<'PY'
          import os, re, pathlib, tempfile

          root = pathlib.Path(os.environ['TMPDOCS'])
          pat_blob = re.compile(r"\((?:https?://[^)]+/blob/[^/]+/)?/?docs/([^\)#]+)(#?[^)]*)\)")
          pat_dot = re.compile(r"\(\./docs/([^\)]+)\)")

          for p in root.rglob('*.md'):
            try:
              text = p.read_text(encoding='utf-8')
            except Exception:
              continue
            new = pat_blob.sub(r"(\1\2)", text)
            new = pat_dot.sub(r"(\1)", new)
            if new != text:
              fd, tmp = tempfile.mkstemp(dir=str(p.parent))
              with os.fdopen(fd, 'w', encoding='utf-8') as f:
                f.write(new)
              os.replace(tmp, p)
          PY

          echo "Syncing rewritten docs -> wiki"
          cd "$TMPDIR"
          rsync -a --delete --exclude='.git' "$TMPDOCS/" .

          if ! git rev-parse --verify --quiet master >/dev/null; then
            git checkout -b master || true
          else
            git checkout master || true
          fi

          git add --all
          if git diff --staged --quiet; then
            echo "No changes to publish to wiki."
            exit 0
          fi

          git commit -m "Sync docs from repo [skip ci]"
          echo "Pushing to wiki"
          if git push origin master; then
            echo "Pushed to master"
          else
            git push origin main || (echo "Push failed; please check PAT permissions and remote branch" && exit 1)
          fi