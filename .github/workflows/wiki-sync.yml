name: Sync Docs to Wiki

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/wiki-sync.yml'

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Publish docs to wiki (inline)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_NAME: github-actions[bot]
          GH_MAIL: github-actions[bot]@users.noreply.github.com
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          if [ ! -d "docs" ]; then
            echo "docs/ directory not found â€” nothing to publish."
            exit 0
          fi

          git --version
          git config --global user.email "$GH_MAIL"
          git config --global user.name "$GH_NAME"
          WORKDIR=$(pwd)

          TMPROOT=$(mktemp -d)
          TMPWIKI="$TMPROOT/wiki"
          TMPDOCS="$TMPROOT/docs_copy"
          mkdir -p "$TMPDOCS"

          echo "Cloning wiki into $TMPWIKI"
          declare -a CANDIDATES
          LAST_URL=""
          if [ -n "${GH_PAT-}" ]; then
            CANDIDATES+=("https://x-access-token:${GH_PAT}@github.com/${REPO}.wiki.git")
          else
            CANDIDATES+=("git@github.com:${REPO}.wiki.git" "https://github.com/${REPO}.wiki.git")
          fi
          CLONED=0
          for url in "${CANDIDATES[@]}"; do
            echo "Trying: $url"
            LAST_URL="$url"
            if git clone --depth 1 "$url" "$TMPWIKI" >/dev/null 2>&1; then
              echo "Cloned wiki from $url"
              CLONED=1
              break
            else
              echo "Failed to clone from $url"
            fi
          done
          if [ "$CLONED" -ne 1 ]; then
            echo "Warning: could not clone wiki (wiki may not be enabled or authentication failed)." >&2
            echo "Proceeding with a local placeholder repo at $TMPWIKI so we can still stage docs." >&2
            mkdir -p "$TMPWIKI"
            git -C "$TMPWIKI" init >/dev/null
            git -C "$TMPWIKI" checkout -b master >/dev/null 2>&1 || git -C "$TMPWIKI" checkout master >/dev/null 2>&1 || true
            if [ -n "$LAST_URL" ]; then
              git -C "$TMPWIKI" remote remove origin >/dev/null 2>&1 || true
              git -C "$TMPWIKI" remote add origin "$LAST_URL" || true
            fi
          fi

          # Copy docs into a temp folder and rewrite simple docs/ prefixes in links
          rsync -a "$WORKDIR/docs/" "$TMPDOCS/"

          # Rewrite patterns like (docs/path/file.md) or (/docs/path/file.md) or blob URLs ending with /docs/...
          # Strip .md extensions from all links since wiki auto-renders markdown
          # Use a small Python script to do atomic in-place edits to avoid sed quoting/portability issues
          TMPDOCS="$TMPDOCS" python3 - <<'PY'
          import os, re, pathlib, tempfile

          root = pathlib.Path(os.environ['TMPDOCS'])
          # Remove docs/ prefix AND .md extension in one pass
          pat_docs_md = re.compile(r"\((?:https?://[^)]+/blob/[^/]+/)?/?docs/([^\)#]+?)\.md(#?[^)]*)\)")
          # Remove ./docs/ prefix and strip .md
          pat_dot_md = re.compile(r"\(\./docs/([^\)#]+?)\.md(#?[^)]*)\)")
          # Strip .md from any remaining link (archive/FILE.md -> archive/FILE)
          pat_md = re.compile(r"\(([^:#)]+?)\.md(#?[^)]*)\)")

          for p in root.rglob('*.md'):
            try:
              text = p.read_text(encoding='utf-8')
            except Exception:
              continue
            new = pat_docs_md.sub(r"(\1\2)", text)
            new = pat_dot_md.sub(r"(\1\2)", new)
            new = pat_md.sub(r"(\1\2)", new)
            if new != text:
              fd, tmp = tempfile.mkstemp(dir=str(p.parent))
              with os.fdopen(fd, 'w', encoding='utf-8') as f:
                f.write(new)
              os.replace(tmp, p)
          PY

          echo "Syncing rewritten docs -> wiki"
          cd "$TMPWIKI"
          # Remove all wiki content except .git so we get a clean sync from rewritten docs
          for item in *; do
            if [ "$item" != ".git" ]; then
              rm -rf "$item"
            fi
          done
          rsync -a --exclude='.git' "$TMPDOCS/" .

          if ! git rev-parse --verify --quiet master >/dev/null; then
            git checkout -b master || true
          else
            git checkout master || true
          fi

          git add --all
          if git diff --staged --quiet; then
            echo "No changes to publish to wiki."
            exit 0
          fi

          git commit -m "Sync docs from repo [skip ci]"
          echo "Pushing to wiki"
          if git push origin master; then
            echo "Pushed to master"
          else
            git push origin main || (echo "Push failed; please check PAT permissions and remote branch" && exit 1)
          fi