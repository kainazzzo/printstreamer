name: Sync Docs to Wiki

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.md'
      - '.github/workflows/wiki-sync.yml'

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Publish docs to wiki (inline)
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
        GH_NAME: github-actions[bot]
        GH_MAIL: github-actions[bot]@users.noreply.github.com
        REPO: ${{ github.repository }}
      run: |
        set -euo pipefail

        if [ ! -d "docs" ]; then
          echo "docs/ directory not found â€” nothing to publish."
          exit 0
        fi

        git --version
        git config --global user.email "$GH_MAIL"
        git config --global user.name "$GH_NAME"

        WIKI_URL="https://x-access-token:${GH_PAT}@github.com/${REPO}.wiki.git"
        TMPDIR=$(mktemp -d)
        echo "Cloning wiki into $TMPDIR"
        if ! git clone "$WIKI_URL" "$TMPDIR"; then
          echo "Could not clone wiki repo. Trying to enable wiki via GitHub API and retry..."
          # Try to enable the wiki feature for the repository (requires PAT with repo scope)
          ENABLE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X PATCH \
            -H "Authorization: token ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}" \
            -d '{"has_wiki":true}') || ENABLE_STATUS=0

          if [ "$ENABLE_STATUS" = "200" ] || [ "$ENABLE_STATUS" = "201" ] || [ "$ENABLE_STATUS" = "204" ]; then
            echo "Enabled wiki (HTTP $ENABLE_STATUS), retrying clone..."
            if ! git clone "$WIKI_URL" "$TMPDIR"; then
              echo "Clone still failed after enabling wiki. Aborting."
              exit 1
            fi
          else
            echo "Failed to enable wiki (HTTP $ENABLE_STATUS). Aborting. Check that GH_PAT has repo permissions and that the repository exists and you have admin access."
            exit 1
          fi
        fi

        echo "Syncing docs/ -> wiki"
        rsync -a --delete docs/ "$TMPDIR/"

        cd "$TMPDIR"
        # Ensure we have a branch to push to (wiki repos commonly use master)
        if ! git rev-parse --verify --quiet master >/dev/null; then
          git checkout -b master || true
        else
          git checkout master || true
        fi

        git add --all
        if git diff --staged --quiet; then
          echo "No changes to publish to wiki."
          exit 0
        fi

        git commit -m "Sync docs from repo [skip ci]"
        echo "Pushing to wiki"
        # Try master then main
        if git push origin master; then
          echo "Pushed to master"
        else
          git push origin main || (echo "Push failed; please check PAT permissions and remote branch" && exit 1)
        fi