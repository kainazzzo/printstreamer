@inject IJSRuntime JS
@inject NavigationManager Nav
<div style="flex:1;display:flex;flex-direction:column">
    <h3 style="margin:6px 0;font-size:1em">Source (raw MJPEG)</h3>
    <div class="preview-wide">
        <img id="mjpeg-overlay" src="/stream/overlay" alt="MJPEG stream"
            style="max-width:100%;height:auto;display:block" />
    </div>

    <div style="display:flex;align-items:center;gap:12px;margin-top:8px">
        <!-- audioPreview id reused to leverage existing audioPreview JS helpers in Components/app.js -->
        <audio id="audioPreview" controls muted autoplay preload="auto" src="/api/audio/stream"
            style="flex:1;min-width:220px"></audio>

        <div style="display:flex;gap:8px;align-items:center">
            <button @onclick="PrevAudio" title="Next"
                style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer">⏭</button>
            <button @onclick="PlayAudio" title="Play"
                style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer">▶</button>
            <button @onclick="PauseAudio" title="Pause"
                style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer">⏸</button>
            <button @onclick="ToggleShuffle" title="Toggle Shuffle"
                style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:@(_shuffleEnabled ? "#28a745" : "#222");color:#fff;cursor:pointer">Shuffle:
                @(_shuffleEnabled ? "On" : "Off")</button>
        </div>
    </div>

    <p style="margin-top:6px">Direct stream URL: <a href="/stream/overlay" style="color:#66ccff">/stream/overlay</a></p>
</div>

@code {
    // audio controls state and DTO
    private bool _shuffleEnabled = false;
    private sealed class AudioStateDto
    {
        public bool IsPlaying { get; set; }
        public string? Current { get; set; }
        public List<string> Queue { get; set; } = new();
        public bool Shuffle { get; set; }
        public string Repeat { get; set; } = "None";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Load initial audio state for shuffle button
            try
            {
                using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
                var st = await client.GetFromJsonAsync<AudioStateDto>("api/audio/state");
                if (st != null) _shuffleEnabled = st.Shuffle;
            }
            catch { }
            StateHasChanged();
        }
    }

    // Audio control actions (reuse audioPreview helpers from Components/app.js)
    private async Task PlayAudio()
    {
        try
        {
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            await client.PostAsync("api/audio/play", null);
            try { await JS.InvokeVoidAsync("audioPreview.play"); } catch { }
        }
        catch { }
    }

    private async Task PauseAudio()
    {
        try
        {
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            await client.PostAsync("api/audio/pause", null);
            try { await JS.InvokeVoidAsync("audioPreview.play"); } catch { }
        }
        catch { }
    }

    private async Task PrevAudio()
    {
        try
        {
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            await client.PostAsync("api/audio/next", null);
            try { await JS.InvokeVoidAsync("audioPreview.reload"); } catch { }
        }
        catch { }
    }

    private async Task ToggleShuffle()
    {
        try
        {
            var en = !_shuffleEnabled;
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            var resp = await client.PostAsync($"api/audio/shuffle?enabled={(en ? "true" : "false")}", null);
            if (resp.IsSuccessStatusCode)
            {
                _shuffleEnabled = en;
            }
        }
        catch { }
        StateHasChanged();
    }
}