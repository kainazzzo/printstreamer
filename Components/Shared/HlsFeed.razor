@inject IJSRuntime JS
@inject NavigationManager Nav

<div style="flex:1;display:flex;flex-direction:column">
    <h3 style="margin:6px 0;font-size:1em">Preview (with overlay)</h3>
    <div id="hlsContainer" class="preview-wide" style="background:#000;">
    <!-- Video stays muted here; audio is served through the separate audio element below -->
    <video id="hlsPlayer" controls autoplay playsinline muted></video>
    </div>

    <div style="display:flex;align-items:center;gap:12px;margin-top:8px">
        <!-- audioPreview id reused to leverage existing audioPreview JS helpers in Components/app.js -->
        <audio id="audioPreview" controls autoplay preload="auto" src="/api/audio/stream" style="flex:1;min-width:220px"></audio>

        <div style="display:flex;gap:8px;align-items:center">
            <button @onclick="PrevAudio" title="Next" style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer">⏭</button>
            <button @onclick="PlayAudio" title="Play" style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer">▶</button>
            <button @onclick="PauseAudio" title="Pause" style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:#222;color:#fff;cursor:pointer">⏸</button>
            <button @onclick="ToggleShuffle" title="Toggle Shuffle" style="padding:6px 10px;border-radius:6px;border:1px solid #444;background:@(_shuffleEnabled ? "#28a745" : "#222");color:#fff;cursor:pointer">Shuffle: @(_shuffleEnabled ? "On" : "Off")</button>
        </div>

        <div id="hlsStatus" style="margin-left:8px;color:#66ccff;font-size:0.9em">HLS status: initializing...</div>
    </div>

    <p style="margin-top:6px">Local HLS: <a href="/hls/stream.m3u8" style="color:#66ccff">/hls/stream.m3u8</a></p>
</div>

@code {
    private bool _isPlaying = false;
    private bool _isMuted = true;
    private double _volume = 0.0; // 0.0 - 1.0

    // audio controls state and DTO
    private bool _shuffleEnabled = false;
    private sealed class AudioStateDto
    {
        public bool IsPlaying { get; set; }
        public string? Current { get; set; }
        public List<string> Queue { get; set; } = new();
        public bool Shuffle { get; set; }
        public string Repeat { get; set; } = "None";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Try to read initial state from JS
            try
            {
                _isMuted = await JS.InvokeAsync<bool>("hlsControls.isMuted");
            }
            catch { }
            try
            {
                _isPlaying = await JS.InvokeAsync<bool>("hlsControls.isPlaying");
            }
            catch { }
            try
            {
                var vol = await JS.InvokeAsync<double>("(function(){ const v=document.getElementById('hlsPlayer'); return v? v.volume : 0; })");
                _volume = Math.Max(0, Math.Min(1, vol));
            }
            catch { }

            // Ensure the HLS video stays muted (audio served via the separate audio element)
            try
            {
                await JS.InvokeVoidAsync("(function(){ const v=document.getElementById('hlsPlayer'); if(v) v.muted = true; })");
            }
            catch { }

            // Load initial audio state for shuffle button
            try
            {
                using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
                var st = await client.GetFromJsonAsync<AudioStateDto>("api/audio/state");
                if (st != null) _shuffleEnabled = st.Shuffle;
            }
            catch { }
            StateHasChanged();
        }
    }

    private async Task TogglePlayPause()
    {
        try
        {
            var playing = await JS.InvokeAsync<bool>("hlsControls.isPlaying");
            if (playing)
            {
                await JS.InvokeVoidAsync("hlsControls.pause");
                _isPlaying = false;
            }
            else
            {
                await JS.InvokeVoidAsync("hlsControls.play");
                _isPlaying = true;
            }
        }
        catch { }
        StateHasChanged();
    }

    private async Task ToggleMute()
    {
        try
        {
            var muted = await JS.InvokeAsync<bool>("hlsControls.toggleMute");
            _isMuted = muted;
        }
        catch { }
        StateHasChanged();
    }

    private async Task VolumeChanged(ChangeEventArgs e)
    {
        try
        {
            if (e?.Value == null) return;
            var v = 0.0;
            if (double.TryParse(e.Value.ToString(), out var iv))
            {
                v = Math.Max(0, Math.Min(100, iv)) / 100.0;
            }
            _volume = v;
            await JS.InvokeVoidAsync("hlsControls.setVolume", _volume);
            _isMuted = await JS.InvokeAsync<bool>("hlsControls.isMuted");
        }
        catch { }
        StateHasChanged();
    }
    
    // Audio control actions (reuse audioPreview helpers from Components/app.js)
    private async Task PlayAudio()
    {
        try
        {
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            await client.PostAsync("api/audio/play", null);
            try { await JS.InvokeVoidAsync("audioPreview.play"); } catch { }
        }
        catch { }
    }

    private async Task PauseAudio()
    {
        try
        {
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            await client.PostAsync("api/audio/pause", null);
            try { await JS.InvokeVoidAsync("audioPreview.play"); } catch { }
        }
        catch { }
    }

    private async Task PrevAudio()
    {
        try
        {
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            await client.PostAsync("api/audio/next", null);
            try { await JS.InvokeVoidAsync("audioPreview.reload"); } catch { }
        }
        catch { }
    }

    private async Task ToggleShuffle()
    {
        try
        {
            var en = !_shuffleEnabled;
            using var client = new System.Net.Http.HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
            var resp = await client.PostAsync($"api/audio/shuffle?enabled={(en ? "true" : "false")}", null);
            if (resp.IsSuccessStatusCode)
            {
                _shuffleEnabled = en;
            }
        }
        catch { }
        StateHasChanged();
    }
    
}
