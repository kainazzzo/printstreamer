<!doctype html>
<html>
<head>
	<meta charset='utf-8'/>
	<title>PrintStreamer - Control Panel</title>
	<style>
		body{margin:0;font-family:sans-serif;background:#111;color:#eee} 
		.wrap{padding:20px;max-width:1200px;margin:0 auto} 
		.section{margin-bottom:30px;background:#222;padding:20px;border-radius:8px}
		.stream-container{text-align:center}
		img{display:block;max-width:100%;height:auto;border:4px solid #333;background:#000;margin:0 auto}
		button{background:#0066cc;color:white;border:none;padding:10px 20px;border-radius:4px;cursor:pointer;margin:5px}
		button:hover{background:#0052a3}
		button:disabled{background:#666;cursor:not-allowed;opacity:0.5}
		button:disabled:hover{background:#666}
		button.danger{background:#cc0000}
		button.danger:hover{background:#a30000}
		button.success{background:#009900}
		button.success:hover{background:#007700}
		.timelapse-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
		.timelapse-item{background:#333;padding:15px;border-radius:8px;word-wrap:break-word;overflow-wrap:break-word}
		.timelapse-item h3{word-wrap:break-word;overflow-wrap:break-word;margin:0 0 10px 0}
		.timelapse-item.active{border:2px solid #0066cc}
		.status{padding:5px 10px;border-radius:4px;font-size:0.9em}
		.status.active{background:#009900}
		.status.inactive{background:#666}
		input{padding:8px;border-radius:4px;border:1px solid #666;background:#333;color:#eee;margin:5px}
		.video-link{color:#66ccff;text-decoration:none}
		.video-link:hover{text-decoration:underline}
		@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
	</style>
</head>
<body>
	<div class='wrap'>
		<h1>PrintStreamer - Control Panel</h1>
		
		<div class='section'>
			<h2>Live Stream Preview</h2>
			<div class='stream-container' style='display:flex;gap:20px;align-items:flex-start'>
				<div style='flex:1;display:flex;flex-direction:column'>
					<h3 style='margin:6px 0;font-size:1em'>Source (raw MJPEG)</h3>
					<div style='width:100%;background:#000;border:4px solid #333;display:flex;align-items:center;justify-content:center'>
						<img id='mjpeg' src='/stream' alt='MJPEG stream' style='width:100%;height:auto;max-height:480px;display:block' />
					</div>
					<p>Direct stream URL: <a href='/stream' style='color:#66ccff'>/stream</a></p>
				</div>
				<div style='flex:1;display:flex;flex-direction:column'>
					<h3 style='margin:6px 0;font-size:1em'>Preview (with overlay)</h3>
					<div id='hlsContainer' style='width:100%;background:#000;border:4px solid #333;display:flex;align-items:center;justify-content:center'>
						<video id='hlsPlayer' autoplay muted playsinline style='width:100%;height:auto;max-height:480px;display:block'></video>
					</div>
					<div id='hlsStatus' style='margin-top:8px;color:#66ccff;font-size:0.9em'>HLS status: initializing...</div>
					<p>Local HLS: <a href='/hls/stream.m3u8' style='color:#66ccff'>/hls/stream.m3u8</a></p>
				</div>
			</div>
		</div>

			<div style='margin-top:12px'>
				<button id='goLiveBtn' class='success' style='display:none'>Go Live</button>
				<button id='stopLiveBtn' class='danger' style='display:none'>Stop Live</button>
				<span id='liveIndicator' style='margin-left:10px;padding:5px 10px;border-radius:4px;display:none'>
					<span style='display:inline-block;width:10px;height:10px;background:#f00;border-radius:50%;margin-right:5px;animation:pulse 1.5s infinite'></span>
					LIVE
				</span>
				<span id='goLiveStatus' style='margin-left:10px;color:#66ccff'></span>
			</div>

		<div class='section'>
			<h2>Timelapse Control</h2>
			<div style='margin-bottom:15px'>
				<button onclick='refreshTimelapses()'>Refresh</button>
			</div>
			<div id='timelapseList'></div>
		</div>
	</div>
	
	<script>
		// Basic reconnection: reload the img if it fails
		const img = document.getElementById('mjpeg');
		const hlsContainer = document.getElementById('hlsContainer');
		let imgReady = false;
		
		// Sync HLS container height with MJPEG image
		function syncHeights() {
			if (img.complete && img.naturalHeight > 0) {
				hlsContainer.style.minHeight = img.offsetHeight + 'px';
			}
		}
		
		img.addEventListener('load', () => {
			syncHeights();
			if (!imgReady) {
				imgReady = true;
				// Try to start HLS playback once the MJPEG source is showing a frame
				try { startHlsIfReady(); } catch (e) { }
			}
		});
		img.addEventListener('error', () => {
			console.log('Stream image error, retrying in 2s');
			setTimeout(() => { img.src = '/stream?ts=' + Date.now(); }, 2000);
		});
		
		// Sync on window resize
		window.addEventListener('resize', syncHeights);
		
		// Initial sync
		setTimeout(syncHeights, 100);

		// Timelapse management
		async function refreshTimelapses() {
			try {
				const response = await fetch('/api/timelapses');
				const timelapses = await response.json();
				displayTimelapses(timelapses);
			} catch (error) {
				console.error('Failed to load timelapses:', error);
			}
		}

		function displayTimelapses(timelapses) {
			const container = document.getElementById('timelapseList');
			if (timelapses.length === 0) {
				container.innerHTML = '<p>No timelapses found.</p>';
				return;
			}

			const html = timelapses.map(t => {
				let itemHtml = `<div class='timelapse-item ${t.isActive ? 'active' : ''}'>`;
				itemHtml += `<h3>${t.name}</h3>`;
				itemHtml += `<div class='status ${t.isActive ? 'active' : 'inactive'}'>${t.isActive ? 'RECORDING' : 'STOPPED'}</div>`;
				itemHtml += `<p><strong>Frames:</strong> ${t.frameCount}</p>`;
				itemHtml += `<p><strong>Started:</strong> ${new Date(t.startTime).toLocaleString()}</p>`;
				if (t.lastFrameTime) {
					itemHtml += `<p><strong>Last Frame:</strong> ${new Date(t.lastFrameTime).toLocaleString()}</p>`;
				}
				itemHtml += '<div>';
				if (t.isActive) {
					itemHtml += `<button onclick='stopTimelapse("${t.name}")' class='danger'>Stop Recording</button>`;
				}
				for (const video of t.videoFiles) {
					itemHtml += ` <a href='/api/timelapses/${encodeURIComponent(t.name)}/frames/${encodeURIComponent(video)}' class='video-link' target='_blank'>ðŸ“¹ ${video}</a>`;
				}
				itemHtml += '</div></div>';
				return itemHtml;
			}).join('');
			
			container.innerHTML = `<div class='timelapse-grid'>${html}</div>`;
		}

		async function startTimelapse(name) {
			if (!name) {
				name = document.getElementById('newTimelapseInput').value.trim();
				if (!name) {
					alert('Please enter a timelapse name');
					return;
				}
			}

			try {
				const response = await fetch(`/api/timelapses/${encodeURIComponent(name)}/start`, { method: 'POST' });
				const result = await response.json();
				if (result.success) {
					document.getElementById('newTimelapseInput').value = '';
					await refreshTimelapses();
				} else {
					alert('Failed to start timelapse: ' + (result.error || 'Unknown error'));
				}
			} catch (error) {
				alert('Error starting timelapse: ' + error.message);
			}
		}

		async function stopTimelapse(name) {
			if (!confirm(`Stop recording '${name}' and create video?`)) return;

			try {
				const response = await fetch(`/api/timelapses/${encodeURIComponent(name)}/stop`, { method: 'POST' });
				const result = await response.json();
				if (result.success) {
					await refreshTimelapses();
					if (result.videoPath) {
						alert('Video created successfully!');
					}
				} else {
					alert('Failed to stop timelapse: ' + (result.error || 'Unknown error'));
				}
			} catch (error) {
				alert('Error stopping timelapse: ' + error.message);
			}
		}

		// Load timelapses on page load
		refreshTimelapses();
		
		// Auto-refresh every 30 seconds
		setInterval(refreshTimelapses, 30000);

		// Global state for live broadcast and stream
		let isLive = false;
		let isStreamPlaying = false;
		
		function updateGoLiveButton() {
			const goLiveBtn = document.getElementById('goLiveBtn');
			// Disable if not live and stream is not playing
			if (!isLive && !isStreamPlaying) {
				goLiveBtn.disabled = true;
				goLiveBtn.title = 'Preview stream must be playing to go live';
			} else {
				goLiveBtn.disabled = false;
				goLiveBtn.title = '';
			}
		}
		
		function updateStreamPlaying(playing) {
			isStreamPlaying = playing;
			updateGoLiveButton();
		}

		// HLS preview: use hls.js when available, otherwise rely on native HLS (Safari)
		(function(){
			const video = document.getElementById('hlsPlayer');
			const hlsUrl = '/hls/stream.m3u8';
			let retryTimeout = null;
			let hlsInstance = null;
			
			// Load hls.js from CDN if necessary
			function loadHls() {
				return new Promise((resolve, reject) => {
					if (window.Hls) return resolve(window.Hls);
					const s = document.createElement('script');
					s.src = 'https://cdn.jsdelivr.net/npm/hls.js@1.5.0/dist/hls.min.js';
					s.onload = () => resolve(window.Hls);
					s.onerror = () => reject(new Error('Failed to load hls.js'));
					document.head.appendChild(s);
				});
			}

			// Helper to update visible status
			function hlsStatus(text) {
				try { document.getElementById('hlsStatus').textContent = 'HLS status: ' + text; } catch (e) { }
				console.log('[HLS] ' + text);
			}

			// Clean up existing HLS instance
			function cleanup() {
				if (hlsInstance) {
					try {
						hlsInstance.destroy();
					} catch (e) {
						console.warn('[HLS] Error destroying instance:', e);
					}
					hlsInstance = null;
				}
				if (retryTimeout) {
					clearTimeout(retryTimeout);
					retryTimeout = null;
				}
				updateStreamPlaying(false);
			}

			// Check if manifest is available
			async function checkManifest() {
				try {
					const resp = await fetch(hlsUrl, { cache: 'no-store' });
					if (resp.ok) {
						const ct = resp.headers.get('content-type') || '';
						if (ct.includes('mpegurl') || ct.includes('vnd.apple.mpegurl') || ct.includes('application/x-mpegurl')) {
							return { ok: true, contentType: ct };
						}
						console.warn('[HLS] Unexpected manifest content-type:', ct);
						return { ok: true, contentType: ct }; // Still try
					}
					return { ok: false, status: resp.status };
				} catch (err) {
					return { ok: false, error: err.message };
				}
			}

			// Attach HLS player
			async function attach() {
				cleanup();
				
				hlsStatus('checking for stream...');
				
				// Check if manifest exists
				const manifestCheck = await checkManifest();
				if (!manifestCheck.ok) {
					if (manifestCheck.status === 404) {
						hlsStatus('waiting for stream (404)');
					} else if (manifestCheck.error) {
						hlsStatus('waiting for stream (error)');
					} else {
						hlsStatus('waiting for stream (' + manifestCheck.status + ')');
					}
					// Retry after 3 seconds
					retryTimeout = setTimeout(() => attach(), 3000);
					return;
				}

				hlsStatus('stream found, attaching...');

				try {
					// Load hls.js if not already loaded
					if (!window.Hls) {
						await loadHls();
					}

					if (window.Hls && window.Hls.isSupported()) {
						// Use hls.js
						hlsInstance = new window.Hls({ 
							liveSyncDuration: 2, 
							maxBufferLength: 10,
							enableWorker: true,
							lowLatencyMode: true
						});
						
						hlsInstance.on(window.Hls.Events.MANIFEST_PARSED, function() {
							hlsStatus('playing');
							updateStreamPlaying(true);
							video.muted = true;
							video.play().catch((e) => {
								console.warn('[HLS] Play failed:', e);
								hlsStatus('play failed (interaction needed)');
							});
						});
						
						hlsInstance.on(window.Hls.Events.ERROR, function(event, data) {
							console.warn('[HLS] Error:', data);
							
							if (data.fatal) {
								hlsStatus('error: ' + (data.details || 'unknown'));
								updateStreamPlaying(false);
								
								switch(data.type) {
									case window.Hls.ErrorTypes.NETWORK_ERROR:
										hlsStatus('network error, retrying...');
										// Retry after 3 seconds
										retryTimeout = setTimeout(() => attach(), 3000);
										break;
									case window.Hls.ErrorTypes.MEDIA_ERROR:
										hlsStatus('media error, attempting recovery...');
										try {
											hlsInstance.recoverMediaError();
										} catch (e) {
											retryTimeout = setTimeout(() => attach(), 3000);
										}
										break;
									default:
										hlsStatus('fatal error, retrying...');
										retryTimeout = setTimeout(() => attach(), 3000);
										break;
								}
							}
						});
						
						hlsInstance.loadSource(hlsUrl);
						hlsInstance.attachMedia(video);
						
					} else if (video.canPlayType('application/vnd.apple.mpegurl')) {
						// Use native HLS (Safari)
						video.src = hlsUrl;
						video.addEventListener('loadedmetadata', function() {
							hlsStatus('playing (native)');
							updateStreamPlaying(true);
							video.muted = true;
							video.play().catch(() => {});
						});
						video.addEventListener('error', function() {
							hlsStatus('error, retrying...');
							updateStreamPlaying(false);
							retryTimeout = setTimeout(() => attach(), 3000);
						});
					} else {
						hlsStatus('HLS not supported');
						updateStreamPlaying(false);
					}
					
				} catch (err) {
					console.warn('[HLS] Attach failed:', err);
					hlsStatus('attach failed, retrying...');
					retryTimeout = setTimeout(() => attach(), 3000);
				}
			}

			// Monitor playback health
			setInterval(() => {
				try {
					if (video.readyState < 2) {
						// Not enough data
						if (hlsInstance && typeof hlsInstance.stopLoad === 'function') {
							hlsInstance.stopLoad();
							hlsInstance.startLoad();
						}
					} else if (!video.paused && video.readyState >= 3) {
						hlsStatus('playing');
					}
				} catch (e) {
					console.warn('[HLS] Health check error:', e);
				}
			}, 5000);

			// Start attachment process
			attach();
		})();

		// Live broadcast state management
		function updateLiveUI(live) {
			isLive = live;
			const goLiveBtn = document.getElementById('goLiveBtn');
			const stopLiveBtn = document.getElementById('stopLiveBtn');
			const liveIndicator = document.getElementById('liveIndicator');
			const status = document.getElementById('goLiveStatus');
			
			if (live) {
				goLiveBtn.style.display = 'none';
				stopLiveBtn.style.display = 'inline-block';
				liveIndicator.style.display = 'inline-block';
			} else {
				goLiveBtn.style.display = 'inline-block';
				stopLiveBtn.style.display = 'none';
				liveIndicator.style.display = 'none';
				updateGoLiveButton();
			}
		}
		
		// Check live status on page load
		async function checkLiveStatus() {
			try {
				const resp = await fetch('/api/live/status');
				if (resp.ok) {
					const j = await resp.json();
					updateLiveUI(j.isLive || false);
				} else {
					updateLiveUI(false);
				}
			} catch (ex) {
				console.warn('Failed to check live status:', ex);
				updateLiveUI(false);
			}
		}
		
		// Go Live button handler
		document.getElementById('goLiveBtn').addEventListener('click', async () => {
			const status = document.getElementById('goLiveStatus');
			status.textContent = 'Starting live broadcast...';
			try {
				const resp = await fetch('/api/live/start', { method: 'POST' });
				const j = await resp.json();
				if (j && j.success) {
					status.textContent = 'Live broadcast started!';
					updateLiveUI(true);
					setTimeout(()=> status.textContent = '', 5000);
				} else {
					status.textContent = 'Failed: ' + (j.error || 'unknown');
				}
			} catch (ex) {
				status.textContent = 'Error: ' + ex.message;
			}
		});
		
		// Stop Live button handler
		document.getElementById('stopLiveBtn').addEventListener('click', async () => {
			if (!confirm('Stop the live broadcast?')) return;
			
			const status = document.getElementById('goLiveStatus');
			status.textContent = 'Stopping live broadcast...';
			try {
				const resp = await fetch('/api/live/stop', { method: 'POST' });
				const j = await resp.json();
				if (j && j.success) {
					status.textContent = 'Live broadcast stopped';
					updateLiveUI(false);
					setTimeout(()=> status.textContent = '', 5000);
				} else {
					status.textContent = 'Failed to stop: ' + (j.error || 'unknown');
				}
			} catch (ex) {
				status.textContent = 'Error: ' + ex.message;
			}
		});
		
		// Check status on load and periodically
		checkLiveStatus();
		setInterval(checkLiveStatus, 30000);
	</script>
</body>
</html>
